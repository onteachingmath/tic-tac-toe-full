<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connect 4 Game</title>
  <style>
    /* Basic styling to make the game visible */
    .game-container {
      max-width: 800px;
      margin: 0 auto;
      font-family: Arial, sans-serif;
    }
    .board {
      margin: 20px 0;
      display: inline-block;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
    }
    .row {
      display: flex;
    }
    .cell {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin: 5px;
      background-color: white;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }
    .cell.player1 {
      background-color: red;
    }
    .cell.player2 {
      background-color: yellow;
    }
    .clickable:hover {
      opacity: 0.8;
    }
    .settings {
      margin: 20px 0;
    }
    .question-area {
      margin: 20px 0;
    }
    .game-status {
      font-weight: bold;
      margin: 10px 0;
    }
    .question-box {
      padding: 15px;
      background-color: #e9f5ff;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .answer-btn {
      margin: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    .question-image {
      max-width: 100%;
      margin: 10px 0;
    }
  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <div class="game-container">
    <h1>Connect 4 Challenge</h1>
    <div class="settings">
      <label for="subject-select">Choose Subject:</label>
      <select id="subject-select"></select>

      <label for="mode-select">Mode:</label>
      <select id="mode-select">
        <option value="1">1 Player</option>
        <option value="2">2 Player</option>
      </select>

      <div id="player-names">
        <input id="player1-name" placeholder="Player 1 Name" />
        <input id="player2-name" placeholder="Player 2/Computer Name" />
      </div>
      <button id="start-btn">Start Game</button>
    </div>

    <div id="board" class="board light-grey-bg"></div>
    <div id="question-area" class="question-area"></div>
    <div id="game-status" class="game-status"></div>
  </div>

  <!-- Sample questions data for testing - replace with your actual data -->
  <script>
    // This would normally be in your questions.js file
    const questions = [
      {
        subject: "Math",
        question_latex: "What is $2 + 2$?",
        correct_answer: "4",
        incorrect_answers: ["3", "5", "6"]
      },
      {
        subject: "Math", 
        question_latex: "What is $5 \\times 3$?",
        correct_answer: "15",
        incorrect_answers: ["12", "18", "8"]
      },
      {
        subject: "Science",
        question_latex: "What is the chemical symbol for water?",
        correct_answer: "H₂O",
        incorrect_answers: ["CO₂", "O₂", "N₂"]
      }
    ];
  </script>

  <script>
    const ROWS = 6;
    const COLS = 7;
    let board = [];
    let currentPlayer = 1;
    let gameMode = 1;
    let playerNames = {};
    let selectedSubject = "";
    let usedQuestions = [];
    let filteredQuestions = [];

    document.addEventListener("DOMContentLoaded", () => {
      const boardEl = document.getElementById("board");
      const subjectSelect = document.getElementById("subject-select");
      const startBtn = document.getElementById("start-btn");
      const questionArea = document.getElementById("question-area");
      const modeSelect = document.getElementById("mode-select");
      
      // Initialize the board immediately so it's visible
      initBoard();
      renderBoard();

      // Populate subject dropdown
      const subjects = [...new Set(questions.map(q => q.subject))];
      subjects.forEach(subj => {
        const option = document.createElement("option");
        option.value = subj;
        option.textContent = subj;
        subjectSelect.appendChild(option);
      });

      // Set default subject if available
      if (subjects.length > 0) {
        selectedSubject = subjects[0];
        subjectSelect.value = selectedSubject;
      }

      // Update player 2 placeholder based on mode
      modeSelect.addEventListener("change", () => {
        const mode = parseInt(modeSelect.value);
        document.getElementById("player2-name").placeholder = 
          mode === 1 ? "Computer Name" : "Player 2 Name";
      });

      startBtn.addEventListener("click", () => {
        selectedSubject = subjectSelect.value;
        gameMode = parseInt(modeSelect.value);
        playerNames[1] = document.getElementById("player1-name").value || "Player 1";
        playerNames[2] = document.getElementById("player2-name").value || 
                         (gameMode === 1 ? "Computer" : "Player 2");
        
        filteredQuestions = questions.filter(q => q.subject === selectedSubject);
        usedQuestions = [];
        currentPlayer = 1;
        
        initBoard();
        renderBoard();
        updateStatus();
      });

      function initBoard() {
        board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
      }

      function renderBoard() {
        boardEl.innerHTML = "";
        for (let r = 0; r < ROWS; r++) {
          const row = document.createElement("div");
          row.className = "row";
          for (let c = 0; c < COLS; c++) {
            const cell = document.createElement("div");
            cell.className = `cell player${board[r][c]}`;
            cell.dataset.col = c;
            if (r === 0) cell.classList.add("clickable");
            row.appendChild(cell);
          }
          boardEl.appendChild(row);
        }
        addListeners();
      }

      function addListeners() {
        const topCells = document.querySelectorAll(".row:first-child .cell");
        topCells.forEach(cell => {
          cell.addEventListener("click", () => {
            const col = parseInt(cell.dataset.col);
            dropPiece(col);
          });
        });
      }

      function dropPiece(col) {
        for (let r = ROWS - 1; r >= 0; r--) {
          if (board[r][col] === 0) {
            askQuestion(r, col);
            return;
          }
        }
      }

      function askQuestion(row, col) {
        const question = getNewQuestion();
        if (!question) {
          alert("No more questions available!");
          return;
        }

        const allAnswers = [question.correct_answer, ...question.incorrect_answers];
        const shuffled = allAnswers.sort(() => Math.random() - 0.5);

        let questionHTML = `<div class='question-box'><p>Player ${currentPlayer}: ${question.question_latex}</p>`;
        if (question.image) {
          questionHTML += `<img src="${question.image}" class="question-image" />`;
        }
        shuffled.forEach((ans, i) => {
          questionHTML += `<button class='answer-btn' data-ans="${ans}">${ans}</button>`;
        });
        questionHTML += `</div>`;

        questionArea.innerHTML = questionHTML;
        if (window.MathJax) {
          MathJax.typeset();
        }

        document.querySelectorAll(".answer-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const selected = btn.dataset.ans;
            const isCorrect = selected === question.correct_answer;
            questionArea.innerHTML = "";
            if (isCorrect) {
              board[row][col] = currentPlayer;
              renderBoard();
              if (checkWin(currentPlayer)) {
                document.getElementById("game-status").textContent = `${playerNames[currentPlayer]} wins!`;
                disableBoard();
                return;
              }
            }
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateStatus();

            if (gameMode === 1 && currentPlayer === 2) {
              setTimeout(() => computerTurn(), 800);
            }
          });
        });
      }

      function getNewQuestion() {
        if (filteredQuestions.length === 0) {
          // If no questions are filtered by subject, use all questions
          filteredQuestions = questions.filter(q => q.subject === selectedSubject);
          if (filteredQuestions.length === 0) {
            return null;
          }
        }
        
        // Find questions that haven't been used yet
        const availableQuestions = filteredQuestions.filter(q => !usedQuestions.includes(q));
        if (availableQuestions.length === 0) {
          // If all questions have been used, reset
          usedQuestions = [];
          return filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
        }
        
        const q = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
        usedQuestions.push(q);
        return q;
      }

      function updateStatus() {
        document.getElementById("game-status").textContent = `${playerNames[currentPlayer]}'s turn`;
      }

      function disableBoard() {
        document.querySelectorAll(".row:first-child .cell").forEach(cell => {
          cell.replaceWith(cell.cloneNode(true));
        });
      }

      function checkWin(player) {
        const directions = [
          [0, 1], [1, 0], [1, 1], [1, -1]
        ];
        for (let r = 0; r < ROWS; r++) {
          for (let c = 0; c < COLS; c++) {
            if (board[r][c] !== player) continue;
            for (let [dr, dc] of directions) {
              let count = 0;
              for (let i = 0; i < 4; i++) {
                const nr = r + dr * i, nc = c + dc * i;
                if (nr < 0 || nr >= ROWS || nc < 0 || nc >= COLS || board[nr][nc] !== player) break;
                count++;
              }
              if (count === 4) return true;
            }
          }
        }
        return false;
      }

      function computerTurn() {
        const validCols = [];
        for (let c = 0; c < COLS; c++) {
          if (board[0][c] === 0) validCols.push(c);
        }
        if (validCols.length === 0) return;

        const col = validCols[Math.floor(Math.random() * validCols.length)];
        for (let r = ROWS - 1; r >= 0; r--) {
          if (board[r][col] === 0) {
            askQuestion(r, col);
            return;
          }
        }
      }
    });
  </script>
</body>
</html>
